@page "/chat"
@using SignalRDemo.Client.Services
@using SignalRDemo.Shared.Models
@using Microsoft.AspNetCore.Components
@implements IAsyncDisposable
@inject ChatService ChatService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="chat-container">
    <!-- å¤´éƒ¨ -->
    <div class="chat-header">
        <div class="chat-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
            </svg>
            å®æ—¶èŠå¤©å®¤
        </div>
        <div class="connection-info">
            <!-- è¿æ¥çŠ¶æ€å¾½ç«  -->
            <span class="status-badge @GetConnectionStatusClass()">
                <span class="status-dot"></span>
                @ChatService.StateText
            </span>
            
            <!-- å½“å‰ç”¨æˆ· -->
            <span class="current-user">
                å½“å‰ç”¨æˆ·: <strong>@ChatService.CurrentUser</strong>
            </span>
            
            <!-- é‡è¿æŒ‰é’® -->
            @if (_showReconnectButton)
            {
                <button class="reconnect-button" @onclick="ReconnectAsync" disabled="@ChatService.IsConnecting">
                    @(ChatService.IsConnecting ? "è¿æ¥ä¸­..." : "é‡æ–°è¿æ¥")
                </button>
            }
        </div>
    </div>

    <!-- èŠå¤©ä¸»ä½“ -->
    <div class="chat-body">
        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div class="chat-messages-wrapper">
            <!-- åŠ è½½ä¸­é®ç½© -->
            @if (ChatService.IsConnecting)
            {
                <div class="loading-overlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">@ChatService.StateText</div>
                </div>
            }

            <div class="chat-messages" @ref="_messagesContainer" id="messagesContainer">
                @if (_messages.Count == 0 && !ChatService.IsConnecting)
                {
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <div class="empty-title">è¿˜æ²¡æœ‰æ¶ˆæ¯</div>
                        <div class="empty-subtitle">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹èŠå¤©å§ï¼</div>
                    </div>
                }
                else
                {
                    @foreach (var message in _messages)
                    {
                        var isOwnMessage = message.User == ChatService.CurrentUser;
                        var isSystemMessage = message.User == "System";
                        
                        @if (isSystemMessage)
                        {
                            <div class="system-message">
                                <span class="system-text">@message.Message</span>
                                <span class="system-time">@FormatTime(message.Timestamp)</span>
                            </div>
                        }
                        else
                        {
                            <div class="message @(isOwnMessage ? "own-message" : "other-message")" @key="message.Timestamp + message.User">
                                <div class="message-avatar" style="background: @GetUserColor(message.User)">
                                    @GetUserInitial(message.User)
                                </div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <span class="message-user">@message.User</span>
                                        <span class="message-time">@FormatTime(message.Timestamp)</span>
                                    </div>
                                    <div class="message-bubble">
                                        @message.Message
                                    </div>
                                </div>
                            </div>
                        }
                    }
                }
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="message-input-area">
                <!-- ç”¨æˆ·åè®¾ç½® -->
                @if (_showUserNameInput)
                {
                    <div class="username-input-wrapper">
                        <input @bind="_newUserName" 
                               @bind:event="oninput"
                               @onkeypress="HandleUserNameKeyPress"
                               placeholder="è¾“å…¥æ‚¨çš„æ˜µç§°..." 
                               class="username-input"
                               maxlength="20" />
                        <button @onclick="SetUserNameAsync" 
                                class="username-button"
                                disabled="@string.IsNullOrWhiteSpace(_newUserName)">
                            è®¾ç½®æ˜µç§°
                        </button>
                    </div>
                }
                else
                {
                    <button class="change-username-button" @onclick="ShowUserNameInput">
                        ä¿®æ”¹æ˜µç§°
                    </button>
                }

                <div class="input-wrapper">
                    <input @bind="_newMessage" 
                           @bind:event="oninput" 
                           @onkeypress="HandleKeyPress"
                           placeholder="è¾“å…¥æ¶ˆæ¯..." 
                           class="message-input"
                           disabled="@(!ChatService.IsConnected)"
                           maxlength="500" />
                    <span class="message-counter">@(_newMessage?.Length ?? 0)/500</span>
                    <button @onclick="SendMessage" 
                            class="send-button" 
                            disabled="@(string.IsNullOrWhiteSpace(_newMessage) || !ChatService.IsConnected)"
                            title="å‘é€æ¶ˆæ¯">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨é¢æ¿ -->
        <div class="user-panel">
            <div class="user-panel-header">
                <div class="user-panel-title">
                    åœ¨çº¿ç”¨æˆ·
                    <span class="user-count">@_connectedUsers.Count</span>
                </div>
            </div>
            <div class="user-list">
                @foreach (var user in _connectedUsers)
                {
                    <div class="user-item" @key="user">
                        <div class="user-item-avatar" style="background: @GetUserColor(user)">
                            @GetUserInitial(user)
                        </div>
                        <div class="user-item-info">
                            <div class="user-item-name @(user == ChatService.CurrentUser ? "current" : "")">
                                @user @(user == ChatService.CurrentUser ? "(æˆ‘)" : "")
                            </div>
                            <div class="user-item-status">
                                <span class="online-dot"></span>
                                åœ¨çº¿
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<ChatMessage> _messages = new();
    private List<string> _connectedUsers = new();
    private string _newMessage = string.Empty;
    private string _newUserName = string.Empty;
    private ElementReference _messagesContainer;
    private bool _shouldScrollToBottom;
    private bool _showUserNameInput = true;
    private bool _showReconnectButton = false;

    // é¢„å®šä¹‰çš„ç”¨æˆ·é¢œè‰²
    private static readonly string[] UserColors = new[]
    {
        "#667eea", "#764ba2", "#f093fb", "#f5576c",
        "#4facfe", "#00f2fe", "#43e97b", "#38f9d7",
        "#fa709a", "#fee140", "#30cfd0", "#330867",
        "#a8edea", "#fed6e3", "#ff9a9e", "#fecfef"
    };

    protected override async Task OnInitializedAsync()
    {
        // è®¢é˜…æœåŠ¡äº‹ä»¶
        ChatService.PropertyChanged += OnPropertyChanged;
        ChatService.MessageReceived += OnMessageReceived;
        ChatService.MessageHistoryReceived += OnMessageHistoryReceived;
        ChatService.UserJoined += OnUserJoined;
        ChatService.UserLeft += OnUserLeft;
        ChatService.UserListUpdated += OnUserListUpdated;
        ChatService.DefaultUserNameReceived += OnDefaultUserNameReceived;
        ChatService.ConnectionClosed += OnConnectionClosed;
        ChatService.Reconnected += OnReconnected;

        await InitializeChatService();
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldScrollToBottom)
        {
            _shouldScrollToBottom = false;
            await ScrollToBottomAsync();
        }
    }

    private void OnPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task InitializeChatService()
    {
        try
        {
            var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
            var hubUrl = $"{baseUrl}/chathub";
            Console.WriteLine($"æ­£åœ¨è¿æ¥åˆ°SignalR Hub: {hubUrl}");

            await ChatService.InitializeAsync(hubUrl);
            Console.WriteLine($"SignalRè¿æ¥çŠ¶æ€: {ChatService.State}");
            _showReconnectButton = !ChatService.IsConnected;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalRè¿æ¥å¤±è´¥: {ex.Message}");
            Console.WriteLine($"å®Œæ•´é”™è¯¯: {ex}");
            _showReconnectButton = true;
        }
    }

    private async Task ReconnectAsync()
    {
        try
        {
            var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
            var hubUrl = $"{baseUrl}/chathub";
            await ChatService.ReconnectAsync(hubUrl);
            _showReconnectButton = !ChatService.IsConnected;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"é‡æ–°è¿æ¥å¤±è´¥: {ex.Message}");
        }
    }

    private void OnMessageReceived(ChatMessage message)
    {
        _messages.Add(message);
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnMessageHistoryReceived(IReadOnlyList<ChatMessage> messages)
    {
        _messages.Clear();
        _messages.AddRange(messages);
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserJoined(string userName)
    {
        _messages.Add(new ChatMessage
        {
            User = "System",
            Message = $"{userName} åŠ å…¥äº†èŠå¤©å®¤",
            Timestamp = DateTime.UtcNow
        });
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserLeft(string userName)
    {
        _messages.Add(new ChatMessage
        {
            User = "System",
            Message = $"{userName} ç¦»å¼€äº†èŠå¤©å®¤",
            Timestamp = DateTime.UtcNow
        });
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserListUpdated(IReadOnlyList<string> userNames)
    {
        _connectedUsers = userNames.ToList();
        InvokeAsync(StateHasChanged);
    }

    private void OnDefaultUserNameReceived(string userName)
    {
        _newUserName = userName;
        InvokeAsync(StateHasChanged);
    }

    private void OnConnectionClosed(Exception? error)
    {
        _showReconnectButton = true;
        if (error != null)
        {
            Console.WriteLine($"è¿æ¥å…³é—­: {error.Message}");
        }
        InvokeAsync(StateHasChanged);
    }

    private void OnReconnected(string connectionId)
    {
        _showReconnectButton = false;
        Console.WriteLine($"å·²é‡è¿: {connectionId}");
        InvokeAsync(StateHasChanged);
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(_newMessage))
        {
            await ChatService.SendMessageAsync(_newMessage);
            _newMessage = string.Empty;
            _shouldScrollToBottom = true;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newMessage))
        {
            await SendMessage();
        }
    }

    private void ShowUserNameInput()
    {
        _newUserName = ChatService.CurrentUser;
        _showUserNameInput = true;
    }

    private async Task SetUserNameAsync()
    {
        if (!string.IsNullOrWhiteSpace(_newUserName))
        {
            await ChatService.SetUserNameAsync(_newUserName);
            _showUserNameInput = false;
        }
    }

    private async Task HandleUserNameKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newUserName))
        {
            await SetUserNameAsync();
        }
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesContainer");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"æ»šåŠ¨å¤±è´¥: {ex.Message}");
        }
    }

    private string GetConnectionStatusClass()
    {
        switch (ChatService.State)
        {
            case ConnectionState.Connected:
                return "connected";
            case ConnectionState.Connecting:
            case ConnectionState.Reconnecting:
                return "connecting";
            case ConnectionState.Failed:
                return "failed";
            default:
                return "disconnected";
        }
    }

    /// <summary>
    /// è·å–ç”¨æˆ·é¦–å­—æ¯
    /// </summary>
    private string GetUserInitial(string userName)
    {
        if (string.IsNullOrEmpty(userName))
            return "?";
        
        var firstChar = userName.Trim().FirstOrDefault();
        return char.ToUpper(firstChar).ToString();
    }

    /// <summary>
    /// è·å–ç”¨æˆ·å¯¹åº”çš„é¢œè‰²ï¼ˆåŸºäºç”¨æˆ·åå“ˆå¸Œï¼‰
    /// </summary>
    private string GetUserColor(string userName)
    {
        if (string.IsNullOrEmpty(userName))
            return UserColors[0];
        
        var hash = userName.GetHashCode();
        var index = Math.Abs(hash) % UserColors.Length;
        return UserColors[index];
    }

    /// <summary>
    /// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    /// </summary>
    private string FormatTime(DateTime timestamp)
    {
        var localTime = timestamp.ToLocalTime();
        var now = DateTime.Now;
        
        if (localTime.Date == now.Date)
        {
            return localTime.ToString("HH:mm");
        }
        else if (localTime.Date == now.AddDays(-1).Date)
        {
            return $"æ˜¨å¤© {localTime:HH:mm}";
        }
        else
        {
            return localTime.ToString("MM-dd HH:mm");
        }
    }

    public async ValueTask DisposeAsync()
    {
        ChatService.PropertyChanged -= OnPropertyChanged;
        ChatService.MessageReceived -= OnMessageReceived;
        ChatService.MessageHistoryReceived -= OnMessageHistoryReceived;
        ChatService.UserJoined -= OnUserJoined;
        ChatService.UserLeft -= OnUserLeft;
        ChatService.UserListUpdated -= OnUserListUpdated;
        ChatService.DefaultUserNameReceived -= OnDefaultUserNameReceived;
        ChatService.ConnectionClosed -= OnConnectionClosed;
        ChatService.Reconnected -= OnReconnected;
        
        await ChatService.DisposeAsync();
    }
}
