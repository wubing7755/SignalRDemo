@page "/chat"
@using SignalRDemo.Client.Services
@using SignalRDemo.Shared.Models
@using SignalRDemo.Client.Components
@implements IAsyncDisposable
@inject ChatService ChatService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILogger<ChatRoom> Logger

<div class="chat-layout">
    <!-- È°∂ÈÉ®Ê†è -->
    <header class="chat-topbar">
        <div class="topbar-left">
            <a href="/" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 class="chat-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
                <span>@GetCurrentRoomName()</span>
            </h1>
        </div>
        <div class="topbar-center">
            <span class="status-badge @GetConnectionStatusClass()">
                <span class="status-dot"></span>
                @ChatService.StateText
            </span>
        </div>
        <div class="topbar-right">
    <div class="user-info" @onclick="ToggleUserMenu">
        <div class="user-avatar-small" style="background: @GetUserColor(ChatService.CurrentUserName)">
            @GetUserInitial(ChatService.CurrentUserName)
        </div>
        <span class="user-name-small">@ChatService.CurrentUserName</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
        </div>
    </header>

    <!-- ‰∏ª‰ΩìÂÜÖÂÆπ -->
    <div class="chat-main">
        <!-- Â∑¶‰æßÔºöÊàøÈó¥ÂàóË°® -->
        <aside class="chat-sidebar-left">
            <RoomList 
                CurrentRoomId="@_currentRoomId"
                Rooms="@_rooms"
                OnRoomSelect="async (roomId) => await HandleRoomSelect(roomId)"
                OnRoomCreate="async (room) => await HandleRoomCreate(room)" />
        </aside>

        <!-- ‰∏≠Èó¥ÔºöÊ∂àÊÅØÂå∫Âüü -->
        <main class="chat-messages-area">
            @if (ChatService.IsConnecting)
            {
                <div class="loading-overlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">@ChatService.StateText</div>
                </div>
            }

            <div class="messages-container" id="messagesContainer" @ref="_messagesContainer">
                @if (_messages.Count == 0 && !ChatService.IsConnecting)
                {
                    <div class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <div class="empty-title">ËøòÊ≤°ÊúâÊ∂àÊÅØ</div>
                        <div class="empty-subtitle">ÂèëÈÄÅÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÂºÄÂßãËÅäÂ§©ÂêßÔºÅ</div>
                    </div>
                }
                else
                {
                    @foreach (var message in _messages)
                    {
                        var isOwnMessage = message.User == ChatService.CurrentUserName;
                        var isSystemMessage = message.User == "System";

                        @if (isSystemMessage)
                        {
                            <div class="system-message">
                                <span class="system-text">@message.Message</span>
                                <span class="system-time">@FormatTime(message.Timestamp)</span>
                            </div>
                        }
                        else
                        {
                            <div class="message @(isOwnMessage ? "own-message" : "other-message")"
                                 @key="message.Timestamp + message.User">
                                <div class="message-avatar" style="background: @GetUserColor(message.User)">
                                    @GetUserInitial(message.User)
                                </div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <span class="message-user">@message.User</span>
                                        <span class="message-time">@FormatTime(message.Timestamp)</span>
                                    </div>
                                    <div class="message-bubble">
                                        @message.Message
                                    </div>
                                </div>
                            </div>
                        }
                    }
                }
            </div>

            <!-- ËæìÂÖ•Âå∫Âüü -->
            <div class="input-area">
                @if (_showUserNameInput)
                {
                    <div class="username-input-wrapper">
                        <input @bind="_newUserName" @bind:event="oninput"
                               @onkeypress="HandleUserNameKeyPress"
                               placeholder="ËæìÂÖ•ÊÇ®ÁöÑÊòµÁß∞..." 
                               class="username-input" 
                               maxlength="20" />
                        <button @onclick="SetUserNameAsync" class="username-button"
                                disabled="@string.IsNullOrWhiteSpace(_newUserName)">
                            ËÆæÁΩÆÊòµÁß∞
                        </button>
                    </div>
                }
                else
                {
                    <div class="message-input-wrapper">
                        <input @bind="_newMessage" @bind:event="oninput" 
                               @onkeypress="HandleKeyPress"
                               placeholder="ËæìÂÖ•Ê∂àÊÅØ..." 
                               class="message-input"
                               disabled="@(!ChatService.IsConnected)"
                               maxlength="500" />
                        <span class="message-counter">@(_newMessage?.Length ?? 0)/500</span>
                        <button @onclick="SendMessage" class="send-button"
                                disabled="@(string.IsNullOrWhiteSpace(_newMessage) || !ChatService.IsConnected)"
                                title="ÂèëÈÄÅÊ∂àÊÅØ">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                }
            </div>
        </main>

        <!-- Âè≥‰æßÔºöÁî®Êà∑ÂàóË°® -->
        <aside class="chat-sidebar-right">
            <UserList 
                Users="@_connectedUsers"
                OnUserClick="HandleUserClick" />
        </aside>
    </div>
</div>

@code {
    private List<ChatMessage> _messages = new();
    private List<string> _connectedUsers = new();
    private List<SignalRDemo.Shared.Models.ChatRoom> _rooms = new();
    private string _newMessage = string.Empty;
    private string _newUserName = string.Empty;
    private ElementReference _messagesContainer;
    private bool _shouldScrollToBottom;
    private bool _showUserNameInput = true;
    private bool _showUserMenu;
    private string _currentRoomId = "lobby";

    private static readonly string[] UserColors = new[]
    {
        "#667eea", "#764ba2", "#f093fb", "#f5576c",
        "#4facfe", "#00f2fe", "#43e97b", "#38f9d7",
        "#fa709a", "#fee140", "#30cfd0", "#330867",
        "#a8edea", "#fed6e3", "#ff9a9e", "#fecfef"
    };

    protected override async Task OnInitializedAsync()
    {
        ChatService.PropertyChanged += OnPropertyChanged;
        ChatService.MessageReceived += OnMessageReceived;
        ChatService.MessageHistoryReceived += OnMessageHistoryReceived;
        ChatService.UserJoined += OnUserJoined;
        ChatService.UserLeft += OnUserLeft;
        ChatService.UserListUpdated += OnUserListUpdated;
        ChatService.DefaultUserNameReceived += OnDefaultUserNameReceived;
        ChatService.ConnectionClosed += OnConnectionClosed;
        ChatService.Reconnected += OnReconnected;

        await InitializeChatService();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldScrollToBottom)
        {
            _shouldScrollToBottom = false;
            await ScrollToBottomAsync();
        }
    }

    private async Task InitializeChatService()
    {
        try
        {
            var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
            var hubUrl = $"{baseUrl}/chathub";
            Logger.LogInformation("Ê≠£Âú®ËøûÊé•Âà∞SignalR Hub: {HubUrl}", hubUrl);

            await ChatService.InitializeAsync(hubUrl);
            Logger.LogInformation("SignalRËøûÊé•Áä∂ÊÄÅ: {State}", ChatService.State);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "SignalRËøûÊé•Â§±Ë¥•");
        }
    }

    private void OnPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnMessageReceived(ChatMessage message)
    {
        // Âè™ÊòæÁ§∫ÂΩìÂâçÊàøÈó¥ÁöÑÊ∂àÊÅØ
        _messages.Add(message);
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnMessageHistoryReceived(IReadOnlyList<ChatMessage> messages)
    {
        _messages.Clear();
        _messages.AddRange(messages);
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserJoined(string userName)
    {
        _messages.Add(new ChatMessage
        {
            User = "System",
            Message = $"{userName} Âä†ÂÖ•‰∫ÜËÅäÂ§©ÂÆ§",
            Timestamp = DateTime.UtcNow
        });
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserLeft(string userName)
    {
        _messages.Add(new ChatMessage
        {
            User = "System",
            Message = $"{userName} Á¶ªÂºÄ‰∫ÜËÅäÂ§©ÂÆ§",
            Timestamp = DateTime.UtcNow
        });
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserListUpdated(IReadOnlyList<string> userNames)
    {
        _connectedUsers = userNames.ToList();
        InvokeAsync(StateHasChanged);
    }

    private void OnDefaultUserNameReceived(string userName)
    {
        _newUserName = userName;
        InvokeAsync(StateHasChanged);
    }

    private void OnConnectionClosed(Exception? error)
    {
        if (error != null)
        {
            Logger.LogWarning(error, "ËøûÊé•ÂÖ≥Èó≠");
        }
        else
        {
            Logger.LogInformation("ËøûÊé•Â∑≤ÂÖ≥Èó≠");
        }
        InvokeAsync(StateHasChanged);
    }

    private void OnReconnected(string connectionId)
    {
        Logger.LogInformation("Â∑≤ÈáçËøû: {ConnectionId}", connectionId);
        InvokeAsync(StateHasChanged);
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(_newMessage))
        {
            await ChatService.SendMessageAsync(_newMessage);
            _newMessage = string.Empty;
            _shouldScrollToBottom = true;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newMessage))
        {
            await SendMessage();
        }
    }

    private async Task HandleUserClick(string userName)
    {
        // ÁÇπÂáªÁî®Êà∑ÂèëËµ∑ÁßÅËÅä
        Logger.LogInformation("ÁÇπÂáªÁî®Êà∑: {UserName}", userName);
        // TODO: ÂÆûÁé∞ÁßÅËÅäÂäüËÉΩ
    }

    private async Task HandleRoomSelect(string roomId)
    {
        _currentRoomId = roomId;
        // TODO: Âä†ËΩΩÊàøÈó¥Ê∂àÊÅØÂéÜÂè≤
        await Task.CompletedTask;
    }

    private async Task HandleRoomCreate(SignalRDemo.Shared.Models.ChatRoom room)
    {
        _rooms.Add(room);
        // TODO: Ë∞ÉÁî®ÊúçÂä°Âô®ÂàõÂª∫ÊàøÈó¥
        await Task.CompletedTask;
    }

    private void ShowUserNameInput()
    {
        _newUserName = ChatService.CurrentUserName;
        _showUserNameInput = true;
    }

    private async Task SetUserNameAsync()
    {
        if (!string.IsNullOrWhiteSpace(_newUserName))
        {
            await ChatService.SetUserNameAsync(_newUserName);
            _showUserNameInput = false;
        }
    }

    private async Task HandleUserNameKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newUserName))
        {
            await SetUserNameAsync();
        }
    }

    private void ToggleUserMenu()
    {
        _showUserMenu = !_showUserMenu;
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesContainer");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "ÊªöÂä®Â§±Ë¥•");
        }
    }

    private string GetConnectionStatusClass()
    {
        switch (ChatService.State)
        {
            case ConnectionState.Connected:
                return "connected";
            case ConnectionState.Connecting:
            case ConnectionState.Reconnecting:
                return "connecting";
            case ConnectionState.Failed:
                return "failed";
            default:
                return "disconnected";
        }
    }

    private string GetCurrentRoomName()
    {
        if (_currentRoomId == "lobby")
            return "Â§ßÂéÖ";
        var room = _rooms.FirstOrDefault(r => r.Id == _currentRoomId);
        return room?.Name ?? "Â§ßÂéÖ";
    }

    private string GetUserInitial(string userName)
    {
        if (string.IsNullOrEmpty(userName))
            return "?";
        var firstChar = userName.Trim().FirstOrDefault();
        return char.ToUpper(firstChar).ToString();
    }

    private string GetUserColor(string userName)
    {
        if (string.IsNullOrEmpty(userName))
            return UserColors[0];
        var hash = userName.GetHashCode();
        var index = Math.Abs(hash) % UserColors.Length;
        return UserColors[index];
    }

    private string FormatTime(DateTime timestamp)
    {
        var localTime = timestamp.ToLocalTime();
        var now = DateTime.Now;

        if (localTime.Date == now.Date)
        {
            return localTime.ToString("HH:mm");
        }
        else if (localTime.Date == now.AddDays(-1).Date)
        {
            return $"Êò®Â§© {localTime:HH:mm}";
        }
        else
        {
            return localTime.ToString("MM-dd HH:mm");
        }
    }

    public async ValueTask DisposeAsync()
    {
        ChatService.PropertyChanged -= OnPropertyChanged;
        ChatService.MessageReceived -= OnMessageReceived;
        ChatService.MessageHistoryReceived -= OnMessageHistoryReceived;
        ChatService.UserJoined -= OnUserJoined;
        ChatService.UserLeft -= OnUserLeft;
        ChatService.UserListUpdated -= OnUserListUpdated;
        ChatService.DefaultUserNameReceived -= OnDefaultUserNameReceived;
        ChatService.ConnectionClosed -= OnConnectionClosed;
        ChatService.Reconnected -= OnReconnected;

        await ChatService.DisposeAsync();
    }
}
