@using SignalRDemo.Client.Services
@using SignalRDemo.Shared.Models
@using Microsoft.AspNetCore.Components
@page "/"

<PageTitle>SignalChat - ÂÆûÊó∂ËÅäÂ§©ÂπøÂú∫</PageTitle>

<div class="index-page">
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <header class="index-header">
        <div class="header-brand">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
            </svg>
            <span>SignalChat</span>
        </div>
        <div class="header-actions">
            @if (ChatService.IsLoggedIn)
            {
                <span class="user-greeting">üë§ @ChatService.CurrentUser?.DisplayName</span>
            }
            <button class="btn-auth" @onclick="ShowAuthModalAsync">
                @(ChatService.IsLoggedIn ? "ÈÄÄÂá∫ÁôªÂΩï" : "ÁôªÂΩï/Ê≥®ÂÜå")
            </button>
            <a href="https://github.com/wubing7755/SignalRDemo" target="_blank" class="btn-github">
                GitHub
            </a>
        </div>
    </header>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <main class="index-main">
        <!-- ÂÆûÊó∂ÁªüËÆ°Èù¢Êùø -->
        <StatsPanel RoomCount="@RoomCount" UserCount="@UserCount" OnRefresh="RefreshStatsAsync" />

        <!-- Âø´ÈÄüÂºÄÂßãÂå∫Âüü -->
        <QuickStart 
            OnEnterLobby="EnterLobbyAsync" 
            OnCreateRoom="ShowCreateRoomModal" 
            OnJoinRoom="ShowJoinRoomModal"
            OnRoomJoined="NavigateToChat" />

        <!-- Êé®ËçêÂÖ¨ÂÖ±ÊàøÈó¥ -->
        <FeaturedRooms OnRoomJoined="NavigateToChat" />
    </main>

    <!-- Â∫ïÈÉ® -->
    <footer class="index-footer">
        <p>¬© 2026 SignalChat</p>
        <div class="footer-links">
            <a href="https://github.com/wubing7755/SignalRDemo" target="_blank">GitHub</a>
            <span class="separator">|</span>
            <a href="#">ÂÖ≥‰∫éÊàë‰ª¨</a>
        </div>
    </footer>
</div>

<!-- ÂºπÁ™óÁªÑ‰ª∂ -->
<AuthModal IsOpen="_showAuthModal" OnAuthStateChanged="OnAuthStateChangedAsync" />
<CreateRoomModal IsOpen="_showCreateRoomModal" OnRoomCreated="OnRoomCreatedAsync" />
<JoinRoomModal IsOpen="_showJoinRoomModal" OnRoomJoined="OnRoomJoinedAsync" />

@code {
    [Inject] private ChatService ChatService { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;

    private int RoomCount { get; set; }
    private int UserCount { get; set; }

    private bool _showAuthModal;
    private bool _showCreateRoomModal;
    private bool _showJoinRoomModal;

    protected override async Task OnInitializedAsync()
    {
        await RefreshStatsAsync();
    }

    private async Task RefreshStatsAsync()
    {
        try
        {
            var rooms = await ChatService.GetRoomsAsync();
            RoomCount = rooms.Count;
            UserCount = rooms.Sum(r => r.MemberCount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•: {ex.Message}");
            RoomCount = 0;
            UserCount = 0;
        }
    }

    private async Task EnterLobbyAsync()
    {
        try
        {
            var rooms = await ChatService.GetRoomsAsync();
            var lobbyRoom = rooms.FirstOrDefault(r => r.Name == "Â§ßÂéÖ" || r.IsPublic);
            if (lobbyRoom != null)
            {
                await ChatService.JoinRoomAsync(lobbyRoom.Id);
                NavigateToChat(lobbyRoom.Id);
            }
            else
            {
                Navigation.NavigateTo("/chat");
            }
        }
        catch
        {
            Navigation.NavigateTo("/chat");
        }
    }

    private void ShowCreateRoomModal()
    {
        _showCreateRoomModal = true;
    }

    private void ShowJoinRoomModal()
    {
        _showJoinRoomModal = true;
    }

    private async Task ShowAuthModalAsync()
    {
        if (ChatService.IsLoggedIn)
        {
            await ChatService.LogoutAsync();
        }
        else
        {
            _showAuthModal = true;
        }
    }

    private void NavigateToChat(string roomId)
    {
        Navigation.NavigateTo($"/chat?room={roomId}");
    }

    private async Task OnAuthStateChangedAsync(bool isOpen)
    {
        _showAuthModal = isOpen;
        await Task.CompletedTask;
    }

    private async Task OnRoomCreatedAsync(string roomId)
    {
        _showCreateRoomModal = false;
        await RefreshStatsAsync();
        NavigateToChat(roomId);
    }

    private async Task OnRoomJoinedAsync(string roomId)
    {
        _showJoinRoomModal = false;
        NavigateToChat(roomId);
    }
}

<style>
    /* È¶ñÈ°µÊ†∑Âºè - ÂÆùÂèØÊ¢¶È£éÊ†ºÈÖçËâ≤ */
    .index-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .index-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
    }

    .header-brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.5rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-greeting {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .btn-auth {
        padding: 0.5rem 1.25rem;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-auth:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-github {
        padding: 0.5rem 1.25rem;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        text-decoration: none;
        border-radius: var(--radius-md);
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-github:hover {
        background: var(--primary);
        color: white;
    }

    .index-main {
        flex: 1;
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        padding: 2rem;
    }

    .index-footer {
        text-align: center;
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
        color: var(--text-muted);
    }

    .footer-links {
        margin-top: 0.5rem;
    }

    .footer-links a {
        color: var(--primary);
        text-decoration: none;
    }

    .footer-links a:hover {
        text-decoration: underline;
    }

    .separator {
        margin: 0 0.75rem;
        color: var(--border-color);
    }

    @@media (max-width: 768px) {
        .index-header {
            padding: 1rem;
            flex-direction: column;
            gap: 1rem;
        }

        .header-actions {
            width: 100%;
            justify-content: center;
        }

        .index-main {
            padding: 1rem;
        }
    }
</style>

