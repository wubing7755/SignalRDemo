@using SignalRDemo.Client.Services
@using SignalRDemo.Shared.Models
@inject ChatService ChatService
@inject NavigationManager NavigationManager

<div class="quick-start">
    <div class="quick-start-header">
        <h2>ğŸš€ å¿«é€Ÿå¼€å§‹</h2>
        <p>é€‰æ‹©æ‚¨æƒ³è¦çš„æ“ä½œ</p>
    </div>

    <div class="quick-start-actions">
        <!-- è¿›å…¥å…¬å…±å¤§å… -->
        <div class="action-card primary" @onclick="EnterLobby">
            <div class="action-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <div class="action-content">
                <h3>å…¬å…±å¤§å…</h3>
                <p>è¿›å…¥å…¬å…±èŠå¤©å®¤ï¼Œä¸æ‰€æœ‰äººä¸€èµ·èŠå¤©</p>
            </div>
            <div class="action-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </div>
        </div>

        <!-- åˆ›å»ºæ–°æˆ¿é—´ -->
        <div class="action-card success" @onclick="ShowCreateRoom">
            <div class="action-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>
            <div class="action-content">
                <h3>åˆ›å»ºæˆ¿é—´</h3>
                <p>åˆ›å»ºä¸€ä¸ªæ–°æˆ¿é—´ï¼Œé‚€è¯·æœ‹å‹åŠ å…¥</p>
            </div>
            <div class="action-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </div>
        </div>

        <!-- åŠ å…¥æˆ¿é—´ -->
        <div class="action-card info" @onclick="ShowJoinRoom">
            <div class="action-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                    <polyline points="10 17 15 12 10 7"></polyline>
                    <line x1="15" y1="12" x2="3" y2="12"></line>
                </svg>
            </div>
            <div class="action-content">
                <h3>åŠ å…¥æˆ¿é—´</h3>
                <p>è¾“å…¥æˆ¿é—´å·æˆ–ä»£ç åŠ å…¥å·²æœ‰æˆ¿é—´</p>
            </div>
            <div class="action-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- å¿«æ·å…¥å£ï¼šæ¨èæˆ¿é—´ -->
    <div class="quick-links">
        <h4>çƒ­é—¨æ¨è</h4>
        <div class="links-grid">
            @foreach (var room in _featuredRooms.Take(3))
            {
                <button class="quick-link" @onclick="() => JoinRoom(room)">
                    <span class="link-icon @(room.IsPublic ? "public" : "private")">
                        @(room.IsPublic ? "ğŸ“¢" : "ğŸ”’")
                    </span>
                    <span class="link-name">@room.Name</span>
                    <span class="link-count">ğŸ‘¥ @room.MemberCount</span>
                </button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback OnEnterLobby { get; set; }

    [Parameter]
    public EventCallback OnCreateRoom { get; set; }

    [Parameter]
    public EventCallback OnJoinRoom { get; set; }

    [Parameter]
    public EventCallback<string> OnRoomJoined { get; set; }

    private List<ChatRoom> _featuredRooms = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadFeaturedRoomsAsync();
    }

    private async Task LoadFeaturedRoomsAsync()
    {
        try
        {
            _featuredRooms = await ChatService.GetRoomsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"åŠ è½½æ¨èæˆ¿é—´å¤±è´¥: {ex.Message}");
            _featuredRooms = new List<ChatRoom>();
        }
    }

    private async Task EnterLobby()
    {
        await OnEnterLobby.InvokeAsync();
    }

    private async Task ShowCreateRoom()
    {
        await OnCreateRoom.InvokeAsync();
    }

    private async Task ShowJoinRoom()
    {
        await OnJoinRoom.InvokeAsync();
    }

    private async Task JoinRoom(ChatRoom room)
    {
        try
        {
            var success = await ChatService.JoinRoomAsync(room.Id);
            if (success)
            {
                await OnRoomJoined.InvokeAsync(room.Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"åŠ å…¥æˆ¿é—´å¤±è´¥: {ex.Message}");
        }
    }
}
