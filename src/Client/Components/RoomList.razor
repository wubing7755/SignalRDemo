<div class="room-list-container">
    <div class="room-list-header">
        <div class="header-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>房间</span>
        </div>
        <button class="create-room-btn" @onclick="ShowCreateRoomModal" title="创建房间">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>

    <div class="room-list">
        <div class="room-item @(CurrentRoomId == "lobby" ? "active" : "")" @onclick="GotoLobby">
            <div class="room-icon lobby">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <div class="room-info">
                <span class="room-name">大厅</span>
                <span class="room-desc">公共聊天室</span>
            </div>
        </div>

        @if (Rooms.Count > 0)
        {
            <div class="room-divider"></div>
            <div class="room-section-title">我的房间</div>
            
            @foreach (var room in Rooms)
            {
                <div class="room-item @(CurrentRoomId == room.Id ? "active" : "")" @onclick="() => GotoRoom(room.Id)">
                    <div class="room-icon custom">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <div class="room-info">
                        <span class="room-name">@room.Name</span>
                        <span class="room-desc">@room.Description</span>
                    </div>
                </div>
            }
        }
    </div>

    @if (_showCreateModal)
    {
        <div class="modal-overlay" @onclick="HideCreateRoomModal">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h3>创建房间</h3>
                    <button class="close-btn" @onclick="HideCreateRoomModal">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>房间名称</label>
                        <input @bind="_newRoomName" placeholder="输入房间名称" maxlength="20" />
                    </div>
                    <div class="form-group">
                        <label>房间描述</label>
                        <input @bind="_newRoomDesc" placeholder="输入房间描述（可选）" maxlength="50" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" @onclick="HideCreateRoomModal">取消</button>
                    <button class="btn-create" @click="CreateRoomAsync" disabled="@string.IsNullOrWhiteSpace(_newRoomName)">
                        创建
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    public class RoomModel
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public bool IsPublic { get; set; } = true;
    }

    [Parameter]
    public string CurrentRoomId { get; set; } = "lobby";

    [Parameter]
    public List<RoomModel> Rooms { get; set; } = new();

    [Parameter]
    public EventCallback<string> OnRoomSelect { get; set; }

    [Parameter]
    public EventCallback<RoomModel> OnRoomCreate { get; set; }

    private bool _showCreateModal;
    private string _newRoomName = string.Empty;
    private string _newRoomDesc = string.Empty;

    private void ShowCreateRoomModal()
    {
        _showCreateModal = true;
        _newRoomName = string.Empty;
        _newRoomDesc = string.Empty;
    }

    private void HideCreateRoomModal()
    {
        _showCreateModal = false;
    }

    private void GotoLobby()
    {
        OnRoomSelect.InvokeAsync("lobby");
    }

    private void GotoRoom(string id)
    {
        OnRoomSelect.InvokeAsync(id);
    }

    private async Task CreateRoomAsync()
    {
        if (string.IsNullOrWhiteSpace(_newRoomName))
            return;

        var room = new RoomModel
        {
            Id = Guid.NewGuid().ToString(),
            Name = _newRoomName.Trim(),
            Description = _newRoomDesc.Trim(),
            CreatedAt = DateTime.UtcNow,
            IsPublic = true
        };

        await OnRoomCreate.InvokeAsync(room);
        _showCreateModal = false;
    }
}
