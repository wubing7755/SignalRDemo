@using SignalRDemo.Client.Services
@using SignalRDemo.Shared.Models
@inject ChatService ChatService
@inject IJSRuntime JSRuntime

<div class="input-area">
    <!-- å·¥å…·æ  -->
    <div class="input-toolbar">
        <button class="toolbar-btn" title="æ’å…¥è¡¨æƒ…" @onclick="ToggleEmojiPicker">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                <line x1="15" y1="9" x2="15.01" y2="9"></line>
            </svg>
        </button>
        <button class="toolbar-btn" title="æ’å…¥å›¾ç‰‡" @onclick="TriggerImageUpload">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
        </button>
        <InputFile OnChange="HandleImageUpload" 
                   style="display: none" 
                   accept="image/*"
                   id="imageFileInput" />
    </div>

    <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
    @if (_showEmojiPicker)
    {
        <div class="emoji-picker">
            <div class="emoji-grid">
                @foreach (var emoji in _commonEmojis)
                {
                    <button class="emoji-btn" @onclick="() => InsertEmoji(emoji)">@emoji</button>
                }
            </div>
        </div>
    }

    <!-- è¾“å…¥æ¡† -->
    <div class="input-wrapper">
        <textarea 
            @bind="_messageText"
            @bind:event="oninput"
            @onkeydown="@HandleKeyDown"
            @onfocus="OnFocus"
            placeholder="è¾“å…¥æ¶ˆæ¯..."
            class="message-input"
            disabled="@(!IsConnected)"
            rows="1"
            maxlength="500"></textarea>
        
        <span class="char-counter">@(_messageText?.Length ?? 0)/500</span>
    </div>

    <!-- å‘é€æŒ‰é’® -->
    <button class="send-btn" 
            disabled="@(string.IsNullOrWhiteSpace(_messageText) || !IsConnected)"
            title="å‘é€æ¶ˆæ¯"
            @onclick="SendMessage">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
    </button>
</div>

@code {
    [Parameter]
    public bool IsConnected { get; set; }

    [Parameter]
    public EventCallback<string> OnSendMessage { get; set; }

    [Parameter]
    public EventCallback<string> OnTyping { get; set; }

    private string? _messageText;
    private bool _showEmojiPicker;

    private static readonly string[] _commonEmojis = new[]
    {
        "ğŸ˜€", "ğŸ˜„", "ğŸ˜Š", "ğŸ™‚", "ğŸ¤—", "ğŸ¥°", "ğŸ˜", "ğŸ¤©",
        "ğŸ˜", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜…", "ğŸ˜†", "ğŸ˜‰",
        "ğŸ˜‹", "ğŸ˜", "ğŸ˜", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜™", "ğŸ˜š", "ğŸ˜‹",
        "ğŸ‘", "ğŸ‘", "ğŸ‘Œ", "âœŒï¸", "ğŸ¤", "ğŸ¤Ÿ", "ğŸ¤˜", "ğŸ‘‹",
        "â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ–¤", "ğŸ’”",
        "ğŸ‰", "ğŸŠ", "ğŸ", "ğŸ†", "â­", "âœ¨", "ğŸ’¡", "ğŸ“¢"
    };

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
        else if (!string.IsNullOrWhiteSpace(_messageText))
        {
            await OnTyping.InvokeAsync(_messageText);
        }
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(_messageText))
        {
            await OnSendMessage.InvokeAsync(_messageText.Trim());
            _messageText = string.Empty;
            _showEmojiPicker = false;
        }
    }

    private void ToggleEmojiPicker()
    {
        _showEmojiPicker = !_showEmojiPicker;
    }

    private void InsertEmoji(string emoji)
    {
        _messageText = (_messageText ?? "") + emoji;
        _showEmojiPicker = false;
    }

    private async Task TriggerImageUpload()
    {
        await JSRuntime.InvokeVoidAsync("document.getElementById('imageFileInput').click()");
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null && file.ContentType.StartsWith("image/"))
        {
            var imageData = await ConvertToBase64(file);
            await OnSendMessage.InvokeAsync($"[IMAGE]{imageData}[/IMAGE]");
        }
    }

    private async Task<string> ConvertToBase64(IBrowserFile file)
    {
        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        var bytes = memoryStream.ToArray();
        return Convert.ToBase64String(bytes);
    }

    private void OnFocus()
    {
        // ç„¦ç‚¹äº‹ä»¶å¤„ç†
    }
}
