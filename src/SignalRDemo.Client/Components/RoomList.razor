@using SignalRDemo.Client.Services
@using SignalRDemo.Shared.Models
@inject ChatService ChatService

<div class="room-list-container">
    <div class="room-list-header">
        <div class="header-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>Rooms</span>
        </div>
        <button class="create-room-btn" @onclick="ShowCreateRoomModal" title="Create Room">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>

    <div class="room-list">
        <div class="room-item @(CurrentRoomId == "lobby" ? "active" : "")" @onclick="GotoLobby">
            <div class="room-icon lobby">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <div class="room-info">
                <span class="room-name">Lobby</span>
                <span class="room-desc">Public Chat Room</span>
            </div>
        </div>

        @if (Rooms.Count > 0)
        {
            <div class="room-divider"></div>
            <div class="room-section-title">My Rooms</div>
            
            @foreach (var room in Rooms)
            {
                <div class="room-item @(CurrentRoomId == room.Id ? "active" : "")" @onclick="() => GotoRoom(room.Id)">
                    <div class="room-icon custom @(room.IsPublic ? "public" : "private")">
                        @(room.IsPublic ? "Public" : "Private")
                    </div>
                    <div class="room-info">
                        <span class="room-name">@room.Name</span>
                        <span class="room-desc">@room.Description</span>
                    </div>
                </div>
            }
        }
    </div>

    @if (_showCreateModal)
    {
        <div class="modal-overlay" @onclick="HideCreateRoomModal">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h3>Create Room</h3>
                    <button class="close-btn" @onclick="HideCreateRoomModal">X</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Room Name</label>
                        <input @bind="_newRoomName" placeholder="Enter room name" maxlength="50" />
                    </div>
                    <div class="form-group">
                        <label>Room Description</label>
                        <input @bind="_newRoomDesc" placeholder="Enter description (optional)" maxlength="200" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" @onclick="HideCreateRoomModal">Cancel</button>
                    <button class="btn-create" @click="CreateRoomAsync" disabled="@string.IsNullOrWhiteSpace(_newRoomName)">
                        Create
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string CurrentRoomId { get; set; } = "lobby";

    [Parameter]
    public List<ChatRoom> Rooms { get; set; } = new();

    [Parameter]
    public EventCallback<string> OnRoomSelect { get; set; }

    [Parameter]
    public EventCallback<ChatRoom> OnRoomCreate { get; set; }

    private bool _showCreateModal;
    private string _newRoomName = string.Empty;
    private string _newRoomDesc = string.Empty;

    private void ShowCreateRoomModal()
    {
        _showCreateModal = true;
        _newRoomName = string.Empty;
        _newRoomDesc = string.Empty;
    }

    private void HideCreateRoomModal()
    {
        _showCreateModal = false;
    }

    private void GotoLobby()
    {
        OnRoomSelect.InvokeAsync("lobby");
    }

    private void GotoRoom(string id)
    {
        OnRoomSelect.InvokeAsync(id);
    }

    private async Task CreateRoomAsync()
    {
        if (string.IsNullOrWhiteSpace(_newRoomName))
            return;

        var room = new ChatRoom
        {
            Id = Guid.NewGuid().ToString(),
            Name = _newRoomName.Trim(),
            Description = _newRoomDesc.Trim(),
            CreatedAt = DateTime.UtcNow,
            IsPublic = true
        };

        await OnRoomCreate.InvokeAsync(room);
        _showCreateModal = false;
    }
}
