@page "/chat"
@using SignalRDemo.Client.Services
@using SignalRDemo.Shared.Models
@using SignalRDemo.Client.Components
@implements IAsyncDisposable
@inject ChatService ChatService
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILogger<ChatRoom> Logger

<div class="chat-layout">
    <!-- é¡¶éƒ¨æ  -->
    <header class="chat-topbar">
        <div class="topbar-left">
            <a href="/" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 class="chat-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
                <span>@GetCurrentRoomName()</span>
            </h1>
        </div>
        <div class="topbar-center">
            <span class="status-badge @GetConnectionStatusClass()">
                <span class="status-dot"></span>
                @ChatService.StateText
            </span>
        </div>
        <div class="topbar-right">
    <div class="user-info" @onclick="ToggleUserMenu">
        <div class="user-avatar-small" style="background: @GetUserColor(ChatService.CurrentUserName)">
            @GetUserInitial(ChatService.CurrentUserName)
        </div>
        <span class="user-name-small">@ChatService.CurrentUserName</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="chat-main">
        <!-- å·¦ä¾§ï¼šæˆ¿é—´åˆ—è¡¨ -->
        <aside class="chat-sidebar-left">
            <RoomList 
                CurrentRoomId="@_currentRoomId"
                Rooms="@_rooms"
                OnRoomSelect="async (roomId) => await HandleRoomSelect(roomId)"
                OnRoomCreate="async (room) => await HandleRoomCreate(room)" />
        </aside>

        <!-- ä¸­é—´ï¼šæ¶ˆæ¯åŒºåŸŸ -->
        <main class="chat-messages-area">
            @if (ChatService.IsConnecting)
            {
                <div class="loading-overlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">@ChatService.StateText</div>
                </div>
            }

            <div class="messages-container" id="messagesContainer" @ref="_messagesContainer">
                @if (_messages.Count == 0 && !ChatService.IsConnecting)
                {
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <div class="empty-title">è¿˜æ²¡æœ‰æ¶ˆæ¯</div>
                        <div class="empty-subtitle">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹èŠå¤©å§ï¼</div>
                    </div>
                }
                else
                {
                    @foreach (var message in _messages)
                    {
                        var isOwnMessage = message.User == ChatService.CurrentUserName;
                        var isSystemMessage = message.User == "System";

                        @if (isSystemMessage)
                        {
                            <div class="system-message">
                                <span class="system-text">@message.Message</span>
                                <span class="system-time">@FormatTime(message.Timestamp)</span>
                            </div>
                        }
                        else
                        {
                            <div class="message @(isOwnMessage ? "own-message" : "other-message")"
                                 @key="message.Timestamp + message.User">
                                <div class="message-avatar" style="background: @GetUserColor(message.User)">
                                    @GetUserInitial(message.User)
                                </div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <span class="message-user">@message.User</span>
                                        <span class="message-time">@FormatTime(message.Timestamp)</span>
                                    </div>
                                    <div class="message-bubble">
                                        @message.Message
                                    </div>
                                </div>
                            </div>
                        }
                    }
                }
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                @if (_showUserNameInput)
                {
                    <div class="username-input-wrapper">
                        <input @bind="_newUserName" @bind:event="oninput"
                               @onkeypress="HandleUserNameKeyPress"
                               placeholder="è¾“å…¥æ‚¨çš„æ˜µç§°..." 
                               class="username-input" 
                               maxlength="20" />
                        <button @onclick="SetUserNameAsync" class="username-button"
                                disabled="@string.IsNullOrWhiteSpace(_newUserName)">
                            è®¾ç½®æ˜µç§°
                        </button>
                    </div>
                }
                else
                {
                    <div class="message-input-wrapper">
                        <input @bind="_newMessage" @bind:event="oninput" 
                               @onkeypress="HandleKeyPress"
                               placeholder="è¾“å…¥æ¶ˆæ¯..." 
                               class="message-input"
                               disabled="@(!ChatService.IsConnected)"
                               maxlength="500" />
                        <span class="message-counter">@(_newMessage?.Length ?? 0)/500</span>
                        <button @onclick="SendMessage" class="send-button"
                                disabled="@(string.IsNullOrWhiteSpace(_newMessage) || !ChatService.IsConnected)"
                                title="å‘é€æ¶ˆæ¯">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                }
            </div>
        </main>

        <!-- å³ä¾§ï¼šç”¨æˆ·åˆ—è¡¨ -->
        <aside class="chat-sidebar-right">
            <UserList 
                Users="@_connectedUsers"
                OnUserClick="HandleUserClick" />
        </aside>
    </div>
</div>

@code {
    private List<ChatMessage> _messages = new();
    private List<string> _connectedUsers = new();
    private List<SignalRDemo.Shared.Models.ChatRoom> _rooms = new();
    private string _newMessage = string.Empty;
    private string _newUserName = string.Empty;
    private ElementReference _messagesContainer;
    private bool _shouldScrollToBottom;
    private bool _showUserNameInput;
    private bool _showUserMenu;
    private string _currentRoomId = "lobby";

    private static readonly string[] UserColors = new[]
    {
        "#667eea", "#764ba2", "#f093fb", "#f5576c",
        "#4facfe", "#00f2fe", "#43e97b", "#38f9d7",
        "#fa709a", "#fee140", "#30cfd0", "#330867",
        "#a8edea", "#fed6e3", "#ff9a9e", "#fecfef"
    };

    protected override async Task OnInitializedAsync()
    {
        ChatService.PropertyChanged += OnPropertyChanged;
        ChatService.MessageReceived += OnMessageReceived;
        ChatService.MessageHistoryReceived += OnMessageHistoryReceived;
        ChatService.UserJoined += OnUserJoined;
        ChatService.UserLeft += OnUserLeft;
        ChatService.UserListUpdated += OnUserListUpdated;
        ChatService.DefaultUserNameReceived += OnDefaultUserNameReceived;
        ChatService.ConnectionClosed += OnConnectionClosed;
        ChatService.Reconnected += OnReconnected;
        ChatService.RoomCreated += OnRoomCreated;
        ChatService.RoomUserListUpdated += OnRoomUserListUpdated;

        await InitializeChatService();
        
        // åŠ è½½ç”¨æˆ·æˆ¿é—´åˆ—è¡¨
        await LoadMyRoomsAsync();
    }
    
    /// <summary>
    /// åŠ è½½ç”¨æˆ·çš„æˆ¿é—´åˆ—è¡¨
    /// </summary>
    private async Task LoadMyRoomsAsync()
    {
        try
        {
            if (ChatService.IsConnected && ChatService.IsLoggedIn)
            {
                var rooms = await ChatService.GetMyRoomsAsync();
                _rooms = rooms;
                Logger.LogInformation("åŠ è½½äº† {Count} ä¸ªç”¨æˆ·æˆ¿é—´", _rooms.Count);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åŠ è½½ç”¨æˆ·æˆ¿é—´åˆ—è¡¨å¤±è´¥");
        }
    }
    
    /// <summary>
    /// æˆ¿é—´åˆ›å»ºæˆåŠŸå¤„ç†
    /// </summary>
    private void OnRoomCreated(JoinRoomResponse response)
    {
        if (response.Success && response.Room != null)
        {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æˆ¿é—´
            var existingRoom = _rooms.FirstOrDefault(r => r.Id == response.Room.Id);
            if (existingRoom == null)
            {
                _rooms.Add(response.Room);
                Logger.LogInformation("æ–°æˆ¿é—´å·²æ·»åŠ åˆ°åˆ—è¡¨: {RoomName}", response.Room.Name);
                InvokeAsync(StateHasChanged);
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldScrollToBottom)
        {
            _shouldScrollToBottom = false;
            await ScrollToBottomAsync();
        }
    }

    private async Task InitializeChatService()
    {
        try
        {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼Œæœªç™»å½•åˆ™è·³è½¬åˆ°é¦–é¡µ
            var isLoggedIn = await AuthService.IsLoggedInAsync();
            if (!isLoggedIn)
            {
                Logger.LogWarning("ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬å›é¦–é¡µ");
                NavigationManager.NavigateTo("/");
                return;
            }

            // å·²ç™»å½•ç”¨æˆ·ä¸å…è®¸ä¿®æ”¹æ˜µç§°
            _showUserNameInput = false;

            // å…³é”®ä¿®å¤ï¼šå¦‚æœå·²ç»åœ¨é¦–é¡µå»ºç«‹äº†è¿æ¥ï¼Œç›´æ¥å¤ç”¨
            if (ChatService.IsConnected)
            {
                Logger.LogInformation("å¤ç”¨å·²æœ‰çš„ SignalR è¿æ¥");
                return;
            }

            var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
            var hubUrl = $"{baseUrl}/chathub";
            Logger.LogInformation("æ­£åœ¨è¿æ¥åˆ°SignalR Hub: {HubUrl}", hubUrl);

            await ChatService.InitializeAsync(hubUrl);
            Logger.LogInformation("SignalRè¿æ¥çŠ¶æ€: {State}", ChatService.State);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "SignalRè¿æ¥å¤±è´¥");
        }
    }

    private void OnPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnMessageReceived(ChatMessage message)
    {
        // åªæ˜¾ç¤ºå½“å‰æˆ¿é—´çš„æ¶ˆæ¯ï¼ˆå…¨å±€æ¶ˆæ¯æˆ–å½“å‰æˆ¿é—´çš„æ¶ˆæ¯ï¼‰
        if (string.IsNullOrEmpty(message.RoomId) || message.RoomId == _currentRoomId)
        {
            _messages.Add(message);
            _shouldScrollToBottom = true;
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnMessageHistoryReceived(IReadOnlyList<ChatMessage> messages)
    {
        _messages.Clear();
        _messages.AddRange(messages);
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserJoined(string userName)
    {
        _messages.Add(new ChatMessage
        {
            User = "System",
            Message = $"{userName} åŠ å…¥äº†èŠå¤©å®¤",
            Timestamp = DateTime.UtcNow
        });
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserLeft(string userName)
    {
        _messages.Add(new ChatMessage
        {
            User = "System",
            Message = $"{userName} ç¦»å¼€äº†èŠå¤©å®¤",
            Timestamp = DateTime.UtcNow
        });
        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private void OnUserListUpdated(IReadOnlyList<string> userNames)
    {
        // å…¨å±€ç”¨æˆ·åˆ—è¡¨æ›´æ–°ï¼Œå¦‚æœæ˜¯å¤§å…åˆ™æ˜¾ç¤º
        if (_currentRoomId == "lobby")
        {
            _connectedUsers = userNames.ToList();
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnRoomUserListUpdated(IReadOnlyList<string> userNames)
    {
        // æˆ¿é—´ç”¨æˆ·åˆ—è¡¨æ›´æ–°
        _connectedUsers = userNames.ToList();
        Logger.LogInformation("æˆ¿é—´ç”¨æˆ·åˆ—è¡¨æ›´æ–°: {Count} ç”¨æˆ·", _connectedUsers.Count);
        InvokeAsync(StateHasChanged);
    }

    private void OnDefaultUserNameReceived(string userName)
    {
        _newUserName = userName;
        InvokeAsync(StateHasChanged);
    }

    private void OnConnectionClosed(Exception? error)
    {
        if (error != null)
        {
            Logger.LogWarning(error, "è¿æ¥å…³é—­");
        }
        else
        {
            Logger.LogInformation("è¿æ¥å·²å…³é—­");
        }
        InvokeAsync(StateHasChanged);
    }

    private void OnReconnected(string connectionId)
    {
        Logger.LogInformation("å·²é‡è¿: {ConnectionId}", connectionId);
        InvokeAsync(StateHasChanged);
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(_newMessage))
        {
            await ChatService.SendMessageAsync(_newMessage);
            _newMessage = string.Empty;
            _shouldScrollToBottom = true;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newMessage))
        {
            await SendMessage();
        }
    }

    private async Task HandleUserClick(string userName)
    {
        // ç‚¹å‡»ç”¨æˆ·å‘èµ·ç§èŠ
        Logger.LogInformation("ç‚¹å‡»ç”¨æˆ·: {UserName}", userName);
        // TODO: å®ç°ç§èŠåŠŸèƒ½
    }

    private async Task HandleRoomSelect(string roomId)
    {
        // å¦‚æœåˆ‡æ¢åˆ°ç›¸åŒæˆ¿é—´ï¼Œä¸åšä»»ä½•æ“ä½œ
        if (_currentRoomId == roomId) return;

        // ç¦»å¼€å½“å‰æˆ¿é—´
        if (!string.IsNullOrEmpty(_currentRoomId) && _currentRoomId != "lobby")
        {
            await ChatService.LeaveRoomAsync();
        }

        _currentRoomId = roomId;
        _messages.Clear();

        // åŠ å…¥æ–°æˆ¿é—´å¹¶åŠ è½½æ¶ˆæ¯å†å²
        if (roomId != "lobby")
        {
            var success = await ChatService.JoinRoomAsync(roomId);
            if (success)
            {
                var messages = await ChatService.GetRoomMessagesAsync(roomId);
                _messages.AddRange(messages);
            }
            else
            {
                // åŠ å…¥å¤±è´¥ï¼Œå›åˆ°å¤§å…
                _currentRoomId = "lobby";
            }
        }
        else
        {
            // å¤§å…ï¼šåŠ è½½å…¨å±€æ¶ˆæ¯å†å²
            await ChatService.GetRecentMessagesAsync();
        }

        _shouldScrollToBottom = true;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleRoomCreate(SignalRDemo.Shared.Models.ChatRoom room)
    {
        try
        {
            // è°ƒç”¨æœåŠ¡å™¨åˆ›å»ºæˆ¿é—´
            await ChatService.CreateRoomAsync(
                room.Name, 
                room.Description, 
                room.IsPublic, 
                null); // å¯†ç æš‚æ—¶ä¸ä¼ ï¼Œå¦‚æœéœ€è¦å¯ä»¥æ‰©å±•
            
            Logger.LogInformation("åˆ›å»ºæˆ¿é—´è¯·æ±‚å·²å‘é€: {RoomName}", room.Name);
            // æ³¨æ„ï¼šæˆ¿é—´åˆ›å»ºæˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¼šå¹¿æ’­ RoomCreated äº‹ä»¶
            // OnRoomCreated æ–¹æ³•ä¼šè‡ªåŠ¨å°†æ–°æˆ¿é—´æ·»åŠ åˆ°åˆ—è¡¨
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åˆ›å»ºæˆ¿é—´å¤±è´¥");
        }
    }

    private void ShowUserNameInput()
    {
        _newUserName = ChatService.CurrentUserName;
        _showUserNameInput = true;
    }

    private async Task SetUserNameAsync()
    {
        if (!string.IsNullOrWhiteSpace(_newUserName))
        {
            await ChatService.SetUserNameAsync(_newUserName);
            _showUserNameInput = false;
        }
    }

    private async Task HandleUserNameKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newUserName))
        {
            await SetUserNameAsync();
        }
    }

    private void ToggleUserMenu()
    {
        _showUserMenu = !_showUserMenu;
        InvokeAsync(StateHasChanged);
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesContainer");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "æ»šåŠ¨å¤±è´¥");
        }
    }

    private string GetConnectionStatusClass()
    {
        switch (ChatService.State)
        {
            case ConnectionState.Connected:
                return "connected";
            case ConnectionState.Connecting:
            case ConnectionState.Reconnecting:
                return "connecting";
            case ConnectionState.Failed:
                return "failed";
            default:
                return "disconnected";
        }
    }

    private string GetCurrentRoomName()
    {
        if (_currentRoomId == "lobby")
            return "å¤§å…";
        var room = _rooms.FirstOrDefault(r => r.Id == _currentRoomId);
        return room?.Name ?? "å¤§å…";
    }

    private string GetUserInitial(string userName)
    {
        if (string.IsNullOrEmpty(userName))
            return "?";
        var firstChar = userName.Trim().FirstOrDefault();
        return char.ToUpper(firstChar).ToString();
    }

    private string GetUserColor(string userName)
    {
        if (string.IsNullOrEmpty(userName))
            return UserColors[0];
        var hash = userName.GetHashCode();
        var index = Math.Abs(hash) % UserColors.Length;
        return UserColors[index];
    }

    private string FormatTime(DateTime timestamp)
    {
        var localTime = timestamp.ToLocalTime();
        var now = DateTime.Now;

        if (localTime.Date == now.Date)
        {
            return localTime.ToString("HH:mm");
        }
        else if (localTime.Date == now.AddDays(-1).Date)
        {
            return $"æ˜¨å¤© {localTime:HH:mm}";
        }
        else
        {
            return localTime.ToString("MM-dd HH:mm");
        }
    }

    public async ValueTask DisposeAsync()
    {
        ChatService.PropertyChanged -= OnPropertyChanged;
        ChatService.MessageReceived -= OnMessageReceived;
        ChatService.MessageHistoryReceived -= OnMessageHistoryReceived;
        ChatService.UserJoined -= OnUserJoined;
        ChatService.UserLeft -= OnUserLeft;
        ChatService.UserListUpdated -= OnUserListUpdated;
        ChatService.DefaultUserNameReceived -= OnDefaultUserNameReceived;
        ChatService.ConnectionClosed -= OnConnectionClosed;
        ChatService.Reconnected -= OnReconnected;
        ChatService.RoomCreated -= OnRoomCreated;
        ChatService.RoomUserListUpdated -= OnRoomUserListUpdated;

        await ChatService.DisposeAsync();
    }
}
